## [M-11] ユーザーの同意なしに手数料を変更することができる脆弱性

### ■ カテゴリー

Fee check

### ■ 条件

注文が成立してから出金までに時間がかかってしまう場合

### ■ ハッキングの詳細

手数料は出金時に適用されますが、注文が成立し、その条件が合意されてから出金までの間に変更されることがあり、当該利用者が期待した資金が失われる可能性がある。

```sol
function setFee(uint256 _fee) public payable onlyOwner {
    require(_fee < 30, "fee must be less than 3%");

    fee = _fee;

    emit NewFee(_fee);
}
```

```sol
uint256 feeAmount = 0;
```

### ■ 修正方法

- 手数料をOrderに格納し、注文が満たされたときに手数料が正しいかどうかを検証する。
- タイムスタンプの追加
- 過去の手数料と手数料変更のタイムスタンプをメモリに保持し（例えば配列で）、出金時に作成時の手数料を取得できるようにする。